  services:
    postgres:
      image: postgres:16-alpine
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      environment:
        POSTGRES_DB: menufaz
        POSTGRES_USER: menufaz
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./backend/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U menufaz"]
        interval: 10s
        timeout: 5s
        retries: 5

    api:
      build:
        context: ./backend
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      volumes:
        - ./logs:/app/logs
      environment:
        DATABASE_URL: postgres://menufaz:${POSTGRES_PASSWORD}@postgres:5432/menufaz
        JWT_SECRET: ${JWT_SECRET}
        CORS_ORIGIN: https://app.menufaz.com
        IMAGEKIT_PRIVATE_KEY: ${IMAGEKIT_PRIVATE_KEY}
        GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
        GEMINI_API_KEY: ${GEMINI_API_KEY}
      depends_on:
        - postgres
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:3001/api/health || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 5

    frontend:
      build:
        context: .
        args:
          VITE_API_BASE_URL: /api
          VITE_IMAGEKIT_PUBLIC_KEY: ${VITE_IMAGEKIT_PUBLIC_KEY}
          VITE_IMAGEKIT_URL_ENDPOINT: ${VITE_IMAGEKIT_URL_ENDPOINT}
          VITE_IMAGEKIT_FOLDER: ${VITE_IMAGEKIT_FOLDER}
          VITE_GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      depends_on:
        - api
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:8080/ || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 5

    frontend-dev:
      image: node:20-alpine
      working_dir: /app
      command: npm run dev -- --host 0.0.0.0 --port 3000
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      volumes:
        - ./:/app
        - /app/node_modules
      environment:
        VITE_API_BASE_URL: http://api:3001/api
        VITE_IMAGEKIT_PUBLIC_KEY: ${VITE_IMAGEKIT_PUBLIC_KEY}
        VITE_IMAGEKIT_URL_ENDPOINT: ${VITE_IMAGEKIT_URL_ENDPOINT}
        VITE_IMAGEKIT_FOLDER: ${VITE_IMAGEKIT_FOLDER}
        VITE_GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      depends_on:
        - api
      profiles:
        - dev
      ports:
        - "3000:3000"

    caddy:
      image: caddy:2
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
        - ./downloads:/srv/downloads:ro
        - caddy_data:/data
        - caddy_config:/config
      depends_on:
        - frontend
        - api
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:2019/config || exit 1"]
        interval: 30s
        timeout: 5s
        retries: 5

  volumes:
    postgres_data:
    caddy_data:
    caddy_config:
